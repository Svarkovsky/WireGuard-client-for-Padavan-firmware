# WireGuard Client for Padavan Routers with Selective VPN Routing

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

## О программе

Этот скрипт представляет собой WireGuard VPN клиент, разработанный для роутеров на базе прошивки Padavan. Его основная функция - обеспечение **селективной маршрутизации трафика** через VPN соединение. Это означает, что вы можете настроить, чтобы только определенные веб-сайты или IP-адреса направлялись через VPN, в то время как остальной трафик будет идти напрямую через ваше обычное интернет-соединение.

**Основное назначение скрипта:**

*   **Обход географических ограничений (гео-блоков):**  Скрипт в первую очередь предназначен для обхода блокировок доступа к контенту, основанных на географическом положении пользователя.
*   **Селективный VPN:**  Вместо направления всего трафика через VPN, вы можете выборочно маршрутизировать только трафик определенных сайтов, что может быть полезно для скорости и экономии ресурсов.
*   **Простота установки и использования:**  Скрипт разработан с учетом ограничений прошивки Padavan и не требует установки дополнительных пакетов (opkg), использования dig, или USB-порта.

## Основные функции

*   **Автоматическое управление IPset:** Скрипт использует `ipset` для создания и управления набором IP-адресов, которые должны маршрутизироваться через VPN.
*   **Интеграция с Dnsmasq:**  Скрипт генерирует конфигурационный файл для `dnsmasq`, чтобы DNS-запросы для определенных доменов автоматически направляли трафик через IPset.
*   **Динамическое обновление IPset:**  Скрипт периодически обновляет IP-адреса доменов из списка `domains.lst`, чтобы IPset оставался актуальным, даже если IP-адреса сайтов меняются.
*   **Поддержка CIDR:**  Возможность добавления в IPset не только отдельных IP-адресов, но и целых CIDR-диапазонов из файла `CIDR.lst`.
*   **Асинхронное разрешение доменов:**  Использование `nslookup` в асинхронном режиме для ускорения обработки больших списков доменов.
*   **Восстановление комментариев IPset из Syslog:**  Функция для добавления комментариев к IP-адресам в IPset на основе данных из системного журнала, что повышает информативность `ipset list`.
*   **Резервное копирование и восстановление IPset:**  Функция для сохранения и восстановления IPset набора при перезагрузке роутера или сбоях питания (опционально).
*   **Выбор конфигурационного файла:** Возможность указать путь к файлу конфигурации WireGuard при запуске скрипта, или автоматическое использование последнего созданного `.conf` файла.
*   **Verbose режим:**  Опция `-v` для включения подробного вывода скрипта.

## Анализ работы скрипта

Скрипт работает следующим образом:

1.  **Чтение конфигурации:** При запуске скрипт считывает настройки из конфигурационного файла WireGuard (по умолчанию последний `.conf` файл в каталоге, или указанный пользователем).
2.  **Создание и обновление IPset:**
    *   Скрипт читает список доменов из файла `config/domains.lst`.
    *   Для каждого домена выполняется асинхронный DNS-запрос (`nslookup`) для получения IP-адресов.
    *   Полученные IP-адреса добавляются в IPset таблицу `unblock-list` с таймаутом и комментарием (имя домена).
    *   Также обрабатывается файл `config/CIDR.lst`, и CIDR диапазоны добавляются в IPset.
3.  **Конфигурация Dnsmasq:**
    *   Скрипт создает конфигурационный файл `unblock.dnsmasq` в каталоге `config/Dnsmasq/`.
    *   В этот файл добавляются строки в формате `ipset=/domain.com/unblock-list` для каждого домена из `domains.lst`. Это указывает Dnsmasq направлять DNS-запросы для этих доменов в IPset.
4.  **Запуск WireGuard:** Скрипт настраивает и запускает WireGuard интерфейс (`wg0` по умолчанию) с параметрами из конфигурационного файла.
5.  **Настройка маршрутизации:**  Скрипт настраивает правила маршрутизации (`iptables`, `ip rule`, `ip route`) для направления трафика, соответствующего IPset `unblock-list`, через WireGuard интерфейс.
6.  **Фоновые процессы:**  В фоновом режиме запускаются процессы для:
    *   Периодического обновления комментариев в IPset на основе данных из `syslog.log`.
    *   Периодического резервного копирования IPset (опционально).
    *   Периодического обновления IP-адресов доменов из `domains.lst`.

**Важно:** IP-адреса в IPset имеют таймаут (по умолчанию 12 часов). Это необходимо для того, чтобы исключить маршрутизацию трафика через VPN для доменов, которые могли изменить свои IP-адреса.

## Инструкция по использованию

**Синтаксис:**

```bash
./wg-client.sh [команда] [-v] [config_file]
