# WireGuard Client for Padavan Routers with Selective VPN Routing

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

**[üá¨üáß English](#english-version) | [üá∫üá¶ –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞](#—É–∫—Ä–∞—ó–Ω—Å—å–∫–∞-–≤–µ—Ä—Å—ñ—è) | [üá®üá≥ ‰∏≠Êñá](#chinese-version) | [üá™üá∏ Espa√±ol](#spanish-version)**

---

## English Version <a name="english-version"></a>

### About

This script is a WireGuard VPN client designed for routers based on Padavan firmware. Its primary function is to provide **selective traffic routing** through a VPN connection. This allows you to configure specific websites or IP addresses to be routed through the VPN, while the rest of your traffic goes directly through your regular internet connection.

**Main Purpose of the Script:**

*   **Bypassing Geo-restrictions (Geo-blocking):** The script is primarily intended to bypass content access restrictions based on geographic location.
*   **Selective VPN:** Instead of routing all traffic through a VPN, you can selectively route only the traffic of specific sites, which can be beneficial for speed and resource efficiency.
*   **Ease of Installation and Use:** The script is designed considering the limitations of Padavan firmware and does not require installing additional packages (opkg), using dig, or a USB port.

### Key Features

*   **Automatic IPset Management:** The script uses `ipset` to create and manage a set of IP addresses that should be routed through the VPN.
*   **Dnsmasq Integration:** The script generates a configuration file for `dnsmasq` so that DNS queries for specific domains automatically route traffic through IPset.
*   **Dynamic IPset Update:** The script periodically updates the IP addresses of domains from the `domains.lst` list to keep the IPset up-to-date, even if website IP addresses change.
*   **CIDR Support:** Ability to add not only individual IP addresses but also entire CIDR ranges to the IPset from the `CIDR.lst` file.
*   **Asynchronous Domain Resolution:** Using `nslookup` in asynchronous mode to speed up processing large lists of domains.
*   **IPset Comment Restoration from Syslog:** Function to add comments to IP addresses in IPset based on data from the system log, enhancing the information in `ipset list`.
*   **IPset Backup and Restore:** Function to save and restore the IPset set upon router reboot or power failures (optional).
*   **Configuration File Selection:** Ability to specify the path to the WireGuard configuration file when running the script, or automatic use of the latest created `.conf` file.
*   **Verbose Mode:** `-v` option to enable detailed script output.

### Script Analysis

The script works as follows:

1.  **Configuration Reading:** Upon startup, the script reads settings from the WireGuard configuration file (by default, the latest `.conf` file in the directory or user-specified).
2.  **IPset Creation and Update:**
    *   The script reads the list of domains from the `config/domains.lst` file.
    *   For each domain, an asynchronous DNS query (`nslookup`) is performed to obtain IP addresses.
    *   The obtained IP addresses are added to the `unblock-list` IPset table with a timeout and comment (domain name).
    *   The `config/CIDR.lst` file is also processed, and CIDR ranges are added to IPset.
3.  **Dnsmasq Configuration:**
    *   The script creates a configuration file `unblock.dnsmasq` in the `config/Dnsmasq/` directory.
    *   Lines in the format `ipset=/domain.com/unblock-list` are added to this file for each domain from `domains.lst`. This instructs Dnsmasq to route DNS queries for these domains to IPset.
4.  **WireGuard Startup:** The script configures and starts the WireGuard interface (`wg0` by default) with parameters from the configuration file.
5.  **Routing Configuration:** The script configures routing rules (`iptables`, `ip rule`, `ip route`) to route traffic matching the `unblock-list` IPset through the WireGuard interface.
6.  **Background Processes:** Background processes are launched for:
    *   Periodic updating of comments in IPset based on data from `syslog.log`.
    *   Periodic IPset backup (optional).
    *   Periodic updating of IP addresses of domains from `domains.lst`.

**Important:** IP addresses in IPset have a timeout (default 12 hours). This is necessary to exclude routing traffic through the VPN for domains that may have changed their IP addresses.

### Authors <a name="authors-english"></a>

- **Spaghetti-jpg**: Original author.
- **Ivan Svarkovsky**: Contributor.

---

## –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –í–µ—Ä—Å—ñ—è <a name="—É–∫—Ä–∞—ó–Ω—Å—å–∫–∞-–≤–µ—Ä—Å—ñ—è"></a>

### –ü—Ä–æ –ø—Ä–æ–≥—Ä–∞–º—É

–¶–µ–π —Å–∫—Ä–∏–ø—Ç —î WireGuard VPN –∫–ª—ñ—î–Ω—Ç–æ–º, —Ä–æ–∑—Ä–æ–±–ª–µ–Ω–∏–º –¥–ª—è —Ä–æ—É—Ç–µ—Ä—ñ–≤ –Ω–∞ –±–∞–∑—ñ –ø—Ä–æ—à–∏–≤–∫–∏ Padavan. –ô–æ–≥–æ –æ—Å–Ω–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è - –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è **—Å–µ–ª–µ–∫—Ç–∏–≤–Ω–æ—ó –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü—ñ—ó —Ç—Ä–∞—Ñ—ñ–∫—É** —á–µ—Ä–µ–∑ VPN –∑'—î–¥–Ω–∞–Ω–Ω—è. –¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ –≤–∏ –º–æ–∂–µ—Ç–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏, —â–æ–± –ª–∏—à–µ –ø–µ–≤–Ω—ñ –≤–µ–±-—Å–∞–π—Ç–∏ –∞–±–æ IP-–∞–¥—Ä–µ—Å–∏ –Ω–∞–ø—Ä–∞–≤–ª—è–ª–∏—Å—è —á–µ—Ä–µ–∑ VPN, –≤ —Ç–æ–π —á–∞—Å —è–∫ —Ä–µ—à—Ç–∞ –≤–∞—à–æ–≥–æ —Ç—Ä–∞—Ñ—ñ–∫—É –±—É–¥–µ –π—Ç–∏ –Ω–∞–ø—Ä—è–º—É —á–µ—Ä–µ–∑ –≤–∞—à–µ –∑–≤–∏—á–∞–π–Ω–µ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç-–∑'—î–¥–Ω–∞–Ω–Ω—è.

**–û—Å–Ω–æ–≤–Ω–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Å–∫—Ä–∏–ø—Ç–∞:**

*   **–û–±—Ö—ñ–¥ –≥–µ–æ–≥—Ä–∞—Ñ—ñ—á–Ω–∏—Ö –æ–±–º–µ–∂–µ–Ω—å (–≥–µ–æ-–±–ª–æ–∫—ñ–≤):** –°–∫—Ä–∏–ø—Ç –≤ –ø–µ—Ä—à—É —á–µ—Ä–≥—É –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –æ–±—Ö–æ–¥—É –±–ª–æ–∫—É–≤–∞–Ω—å –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É, —â–æ –±–∞–∑—É—é—Ç—å—Å—è –Ω–∞ –≥–µ–æ–≥—Ä–∞—Ñ—ñ—á–Ω–æ–º—É –ø–æ–ª–æ–∂–µ–Ω–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.
*   **–°–µ–ª–µ–∫—Ç–∏–≤–Ω–∏–π VPN:** –ó–∞–º—ñ—Å—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –≤—Å—å–æ–≥–æ —Ç—Ä–∞—Ñ—ñ–∫—É —á–µ—Ä–µ–∑ VPN, –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∏–±—ñ—Ä–∫–æ–≤–æ –º–∞—Ä—à—Ä—É—Ç–∏–∑—É–≤–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ —Ç—Ä–∞—Ñ—ñ–∫ –ø–µ–≤–Ω–∏—Ö —Å–∞–π—Ç—ñ–≤, —â–æ –º–æ–∂–µ –±—É—Ç–∏ –∫–æ—Ä–∏—Å–Ω–∏–º –¥–ª—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ —Ç–∞ –µ–∫–æ–Ω–æ–º—ñ—ó —Ä–µ—Å—É—Ä—Å—ñ–≤.
*   **–ü—Ä–æ—Å—Ç–æ—Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:** –°–∫—Ä–∏–ø—Ç —Ä–æ–∑—Ä–æ–±–ª–µ–Ω–∏–π –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –æ–±–º–µ–∂–µ–Ω—å –ø—Ä–æ—à–∏–≤–∫–∏ Padavan —ñ –Ω–µ –≤–∏–º–∞–≥–∞—î –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –ø–∞–∫–µ—Ç—ñ–≤ (opkg), –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è dig, –∞–±–æ USB-–ø–æ—Ä—Ç—É.

### –û—Å–Ω–æ–≤–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó

*   **–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è IPset:** –°–∫—Ä–∏–ø—Ç –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `ipset` –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –Ω–∞–±–æ—Ä–æ–º IP-–∞–¥—Ä–µ—Å, —è–∫—ñ –ø–æ–≤–∏–Ω–Ω—ñ –º–∞—Ä—à—Ä—É—Ç–∏–∑—É–≤–∞—Ç–∏—Å—è —á–µ—Ä–µ–∑ VPN.
*   **–Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ Dnsmasq:** –°–∫—Ä–∏–ø—Ç –≥–µ–Ω–µ—Ä—É—î –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–∏–π —Ñ–∞–π–ª –¥–ª—è `dnsmasq`, —â–æ–± DNS-–∑–∞–ø–∏—Ç–∏ –¥–ª—è –ø–µ–≤–Ω–∏—Ö –¥–æ–º–µ–Ω—ñ–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –Ω–∞–ø—Ä–∞–≤–ª—è–ª–∏ —Ç—Ä–∞—Ñ—ñ–∫ —á–µ—Ä–µ–∑ IPset.
*   **–î–∏–Ω–∞–º—ñ—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è IPset:** –°–∫—Ä–∏–ø—Ç –ø–µ—Ä—ñ–æ–¥–∏—á–Ω–æ –æ–Ω–æ–≤–ª—é—î IP-–∞–¥—Ä–µ—Å–∏ –¥–æ–º–µ–Ω—ñ–≤ –∑—ñ —Å–ø–∏—Å–∫—É `domains.lst`, —â–æ–± IPset –∑–∞–ª–∏—à–∞–≤—Å—è –∞–∫—Ç—É–∞–ª—å–Ω–∏–º, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ IP-–∞–¥—Ä–µ—Å–∏ —Å–∞–π—Ç—ñ–≤ –∑–º—ñ–Ω—é—é—Ç—å—Å—è.
*   **–ü—ñ–¥—Ç—Ä–∏–º–∫–∞ CIDR:** –ú–æ–∂–ª–∏–≤—ñ—Å—Ç—å –¥–æ–¥–∞–≤–∞–Ω–Ω—è –≤ IPset –Ω–µ —Ç—ñ–ª—å–∫–∏ –æ–∫—Ä–µ–º–∏—Ö IP-–∞–¥—Ä–µ—Å, –∞–ª–µ –π —Ü—ñ–ª–∏—Ö CIDR-–¥—ñ–∞–ø–∞–∑–æ–Ω—ñ–≤ –∑ —Ñ–∞–π–ª—É `CIDR.lst`.
*   **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–µ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –¥–æ–º–µ–Ω—ñ–≤:** –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è `nslookup` –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º—É —Ä–µ–∂–∏–º—ñ –¥–ª—è –ø—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è –æ–±—Ä–æ–±–∫–∏ –≤–µ–ª–∏–∫–∏—Ö —Å–ø–∏—Å–∫—ñ–≤ –¥–æ–º–µ–Ω—ñ–≤.
*   **–í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤ IPset –∑ Syslog:** –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤ –¥–æ IP-–∞–¥—Ä–µ—Å –≤ IPset –Ω–∞ –æ—Å–Ω–æ–≤—ñ –¥–∞–Ω–∏—Ö –∑ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –∂—É—Ä–Ω–∞–ª—É, —â–æ –ø—ñ–¥–≤–∏—â—É—î —ñ–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ñ—Å—Ç—å `ipset list`.
*   **–†–µ–∑–µ—Ä–≤–Ω–µ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è —Ç–∞ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è IPset:** –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–∞ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è IPset –Ω–∞–±–æ—Ä—É –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Ä–æ—É—Ç–µ—Ä–∞ –∞–±–æ –∑–±–æ—è—Ö –∂–∏–≤–ª–µ–Ω–Ω—è (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ).
*   **–í–∏–±—ñ—Ä –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–æ–≥–æ —Ñ–∞–π–ª—É:** –ú–æ–∂–ª–∏–≤—ñ—Å—Ç—å –≤–∫–∞–∑–∞—Ç–∏ —à–ª—è—Ö –¥–æ —Ñ–∞–π–ª—É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó WireGuard –ø—Ä–∏ –∑–∞–ø—É—Å–∫—É —Å–∫—Ä–∏–ø—Ç–∞, –∞–±–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ–≥–æ `.conf` —Ñ–∞–π–ª—É.
*   **Verbose —Ä–µ–∂–∏–º:** –û–ø—Ü—ñ—è `-v` –¥–ª—è –≤–∫–ª—é—á–µ–Ω–Ω—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –≤–∏–≤–æ–¥—É —Å–∫—Ä–∏–ø—Ç–∞.

### –ê–Ω–∞–ª—ñ–∑ —Ä–æ–±–æ—Ç–∏ —Å–∫—Ä–∏–ø—Ç–∞

–°–∫—Ä–∏–ø—Ç –ø—Ä–∞—Ü—é—î –Ω–∞—Å—Ç—É–ø–Ω–∏–º —á–∏–Ω–æ–º:

1.  **–ß–∏—Ç–∞–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó:** –ü—Ä–∏ –∑–∞–ø—É—Å–∫—É —Å–∫—Ä–∏–ø—Ç –∑—á–∏—Ç—É—î –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–æ–≥–æ —Ñ–∞–π–ª—É WireGuard (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –æ—Å—Ç–∞–Ω–Ω—ñ–π `.conf` —Ñ–∞–π–ª –≤ –∫–∞—Ç–∞–ª–æ–∑—ñ, –∞–±–æ –≤–∫–∞–∑–∞–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º).
2.  **–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è IPset:**
    *   –°–∫—Ä–∏–ø—Ç —á–∏—Ç–∞—î —Å–ø–∏—Å–æ–∫ –¥–æ–º–µ–Ω—ñ–≤ –∑ —Ñ–∞–π–ª—É `config/domains.lst`.
    *   –î–ª—è –∫–æ–∂–Ω–æ–≥–æ –¥–æ–º–µ–Ω—É –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π DNS-–∑–∞–ø–∏—Ç (`nslookup`) –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è IP-–∞–¥—Ä–µ—Å.
    *   –û—Ç—Ä–∏–º–∞–Ω—ñ IP-–∞–¥—Ä–µ—Å–∏ –¥–æ–¥–∞—é—Ç—å—Å—è –¥–æ IPset —Ç–∞–±–ª–∏—Ü—ñ `unblock-list` –∑ —Ç–∞–π–º-–∞—É—Ç–æ–º —Ç–∞ –∫–æ–º–µ–Ω—Ç–∞—Ä–µ–º (—ñ–º'—è –¥–æ–º–µ–Ω—É).
    *   –¢–∞–∫–æ–∂ –æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è —Ñ–∞–π–ª `config/CIDR.lst`, —ñ CIDR –¥—ñ–∞–ø–∞–∑–æ–Ω–∏ –¥–æ–¥–∞—é—Ç—å—Å—è –¥–æ IPset.
3.  **–ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è Dnsmasq:**
    *   –°–∫—Ä–∏–ø—Ç —Å—Ç–≤–æ—Ä—é—î –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–∏–π —Ñ–∞–π–ª `unblock.dnsmasq` –≤ –∫–∞—Ç–∞–ª–æ–∑—ñ `config/Dnsmasq/`.
    *   –í —Ü–µ–π —Ñ–∞–π–ª –¥–æ–¥–∞—é—Ç—å—Å—è —Ä—è–¥–∫–∏ —É —Ñ–æ—Ä–º–∞—Ç—ñ `ipset=/domain.com/unblock-list` –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –¥–æ–º–µ–Ω—É –∑ `domains.lst`. –¶–µ –≤–∫–∞–∑—É—î Dnsmasq –Ω–∞–ø—Ä–∞–≤–ª—è—Ç–∏ DNS-–∑–∞–ø–∏—Ç–∏ –¥–ª—è —Ü–∏—Ö –¥–æ–º–µ–Ω—ñ–≤ –¥–æ IPset.
4.  **–ó–∞–ø—É—Å–∫ WireGuard:** –°–∫—Ä–∏–ø—Ç –Ω–∞–ª–∞—à—Ç–æ–≤—É—î —Ç–∞ –∑–∞–ø—É—Å–∫–∞—î WireGuard —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å (`wg0` –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º) –∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∑ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–æ–≥–æ —Ñ–∞–π–ª—É.
5.  **–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü—ñ—ó:** –°–∫—Ä–∏–ø—Ç –Ω–∞–ª–∞—à—Ç–æ–≤—É—î –ø—Ä–∞–≤–∏–ª–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü—ñ—ó (`iptables`, `ip rule`, `ip route`) –¥–ª—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è —Ç—Ä–∞—Ñ—ñ–∫—É, —â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î IPset `unblock-list`, —á–µ—Ä–µ–∑ WireGuard —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å.
6.  **–§–æ–Ω–æ–≤—ñ –ø—Ä–æ—Ü–µ—Å–∏:** –£ —Ñ–æ–Ω–æ–≤–æ–º—É —Ä–µ–∂–∏–º—ñ –∑–∞–ø—É—Å–∫–∞—é—Ç—å—Å—è –ø—Ä–æ—Ü–µ—Å–∏ –¥–ª—è:
    *   –ü–µ—Ä—ñ–æ–¥–∏—á–Ω–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤ –≤ IPset –Ω–∞ –æ—Å–Ω–æ–≤—ñ –¥–∞–Ω–∏—Ö –∑ `syslog.log`.
    *   –ü–µ—Ä—ñ–æ–¥–∏—á–Ω–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è IPset (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ).
    *   –ü–µ—Ä—ñ–æ–¥–∏—á–Ω–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è IP-–∞–¥—Ä–µ—Å –¥–æ–º–µ–Ω—ñ–≤ –∑ `domains.lst`.

**–í–∞–∂–ª–∏–≤–æ:** IP-–∞–¥—Ä–µ—Å–∏ –≤ IPset –º–∞—é—Ç—å —Ç–∞–π–º-–∞—É—Ç (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º 12 –≥–æ–¥–∏–Ω). –¶–µ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –¥–ª—è —Ç–æ–≥–æ, —â–æ–± –≤–∏–∫–ª—é—á–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü—ñ—é —Ç—Ä–∞—Ñ—ñ–∫—É —á–µ—Ä–µ–∑ VPN –¥–ª—è –¥–æ–º–µ–Ω—ñ–≤, —è–∫—ñ –º–æ–≥–ª–∏ –∑–º—ñ–Ω–∏—Ç–∏ —Å–≤–æ—ó IP-–∞–¥—Ä–µ—Å–∏.

### –ê–≤—Ç–æ—Ä–∏ <a name="authors-ukrainian"></a>

- **Spaghetti-jpg**: –û—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –∞–≤—Ç–æ—Ä.
- **Ivan Svarkovsky**: –ö–æ–Ω—Ç—Ä–∏–±—É—Ç–æ—Ä.

---

## ‰∏≠ÊñáÁâà <a name="chinese-version"></a>

### ÂÖ≥‰∫é

ËØ•ËÑöÊú¨ÊòØ‰∏Ä‰∏™ WireGuard VPN ÂÆ¢Êà∑Á´ØÔºå‰∏ì‰∏∫Âü∫‰∫é Padavan Âõ∫‰ª∂ÁöÑË∑ØÁî±Âô®ËÆæËÆ°„ÄÇÂÖ∂‰∏ªË¶ÅÂäüËÉΩÊòØÊèê‰æõÈÄöËøá VPN ËøûÊé•ÁöÑ**ÈÄâÊã©ÊÄßÊµÅÈáèË∑ØÁî±**„ÄÇËøôÂÖÅËÆ∏ÊÇ®ÈÖçÁΩÆÁâπÂÆöÁöÑÁΩëÁ´ôÊàñ IP Âú∞ÂùÄÈÄöËøá VPN Ë∑ØÁî±ÔºåËÄåÂÖ∂‰ΩôÊµÅÈáèÂàôÁõ¥Êé•ÈÄöËøáÊÇ®ÁöÑÂ∏∏ËßÑ‰∫íËÅîÁΩëËøûÊé•„ÄÇ

**ËÑöÊú¨ÁöÑ‰∏ªË¶ÅÁõÆÁöÑÔºö**

*   **ÁªïËøáÂú∞ÁêÜÈôêÂà∂ÔºàÂú∞ÁêÜÂ∞ÅÈîÅÔºâÔºö** ËØ•ËÑöÊú¨‰∏ªË¶ÅÁî®‰∫éÁªïËøáÂü∫‰∫éÁî®Êà∑Âú∞ÁêÜ‰ΩçÁΩÆÁöÑÂÜÖÂÆπËÆøÈóÆÈôêÂà∂„ÄÇ
*   **ÈÄâÊã©ÊÄß VPNÔºö** ÊÇ®ÂèØ‰ª•ÈÄâÊã©ÊÄßÂú∞‰ªÖË∑ØÁî±ÁâπÂÆöÁ´ôÁÇπÁöÑÊµÅÈáèÔºåËÄå‰∏çÊòØÈÄöËøá VPN Ë∑ØÁî±ÊâÄÊúâÊµÅÈáèÔºåËøôÂèØËÉΩÊúâÂà©‰∫éÈÄüÂ∫¶ÂíåËµÑÊ∫êÊïàÁéá„ÄÇ
*   **Êòì‰∫éÂÆâË£ÖÂíå‰ΩøÁî®Ôºö** ËØ•ËÑöÊú¨Âú®ËÆæËÆ°Êó∂ËÄÉËôë‰∫Ü Padavan Âõ∫‰ª∂ÁöÑÈôêÂà∂Ôºå‰∏çÈúÄË¶ÅÂÆâË£ÖÈ¢ùÂ§ñÁöÑËΩØ‰ª∂ÂåÖ (opkg)„ÄÅ‰ΩøÁî® dig Êàñ USB Á´ØÂè£„ÄÇ

### ‰∏ªË¶ÅÁâπÁÇπ

*   **Ëá™Âä® IPset ÁÆ°ÁêÜÔºö** ËØ•ËÑöÊú¨‰ΩøÁî® `ipset` ÂàõÂª∫ÂíåÁÆ°ÁêÜÂ∫îÈÄöËøá VPN Ë∑ØÁî±ÁöÑ IP Âú∞ÂùÄÈõÜ„ÄÇ
*   **Dnsmasq ÈõÜÊàêÔºö** ËØ•ËÑöÊú¨‰∏∫ `dnsmasq` ÁîüÊàêÈÖçÁΩÆÊñá‰ª∂Ôºå‰ª•‰æøÁâπÂÆöÂüüÂêçÁöÑ DNS Êü•ËØ¢Ëá™Âä®ÈÄöËøá IPset Ë∑ØÁî±ÊµÅÈáè„ÄÇ
*   **Âä®ÊÄÅ IPset Êõ¥Êñ∞Ôºö** ËØ•ËÑöÊú¨ÂÆöÊúüÊõ¥Êñ∞ `domains.lst` ÂàóË°®‰∏≠ÂüüÂêçÁöÑ IP Âú∞ÂùÄÔºå‰ª•‰øùÊåÅ IPset ÁöÑÊúÄÊñ∞Áä∂ÊÄÅÔºåÂç≥‰ΩøÁΩëÁ´ô IP Âú∞ÂùÄÂèëÁîüÊõ¥Êîπ‰πüÊòØÂ¶ÇÊ≠§„ÄÇ
*   **CIDR ÊîØÊåÅÔºö** ËÉΩÂ§ü‰ªé `CIDR.lst` Êñá‰ª∂Âêë IPset Ê∑ªÂä†‰∏ç‰ªÖÊòØÂçï‰∏™ IP Âú∞ÂùÄÔºåËÄå‰∏îÊòØÊï¥‰∏™ CIDR ËåÉÂõ¥„ÄÇ
*   **ÂºÇÊ≠•ÂüüÂêçËß£ÊûêÔºö** ‰ΩøÁî®ÂºÇÊ≠•Ê®°Âºè‰∏ãÁöÑ `nslookup` Âä†ÈÄüÂ§ÑÁêÜÂ§ßÂûãÂüüÂêçÂàóË°®„ÄÇ
*   **‰ªé Syslog ÊÅ¢Â§ç IPset Ê≥®ÈáäÔºö** Ê†πÊçÆÁ≥ªÁªüÊó•Âøó‰∏≠ÁöÑÊï∞ÊçÆÂêë IPset ‰∏≠ÁöÑ IP Âú∞ÂùÄÊ∑ªÂä†Ê≥®ÈáäÁöÑÂäüËÉΩÔºåÂ¢ûÂº∫‰∫Ü `ipset list` ‰∏≠ÁöÑ‰ø°ÊÅØ„ÄÇ
*   **IPset Â§á‰ªΩÂíåÊÅ¢Â§çÔºö** Âú®Ë∑ØÁî±Âô®ÈáçÂêØÊàñÁîµÊ∫êÊïÖÈöúÊó∂‰øùÂ≠òÂíåÊÅ¢Â§ç IPset ÈõÜÁöÑÂäüËÉΩÔºàÂèØÈÄâÔºâ„ÄÇ
*   **ÈÖçÁΩÆÊñá‰ª∂ÈÄâÊã©Ôºö** ËÉΩÂ§üÂú®ËøêË°åËÑöÊú¨Êó∂ÊåáÂÆö WireGuard ÈÖçÁΩÆÊñá‰ª∂ÁöÑË∑ØÂæÑÔºåÊàñËá™Âä®‰ΩøÁî®ÊúÄÊñ∞ÂàõÂª∫ÁöÑ `.conf` Êñá‰ª∂„ÄÇ
*   **ËØ¶ÁªÜÊ®°ÂºèÔºö** `-v` ÈÄâÈ°πÂêØÁî®ËØ¶ÁªÜÁöÑËÑöÊú¨ËæìÂá∫„ÄÇ

### ËÑöÊú¨ÂàÜÊûê

ËØ•ËÑöÊú¨ÁöÑÂ∑•‰ΩúÊñπÂºèÂ¶Ç‰∏ãÔºö

1.  **ÈÖçÁΩÆËØªÂèñÔºö** ÂêØÂä®Êó∂ÔºåËÑöÊú¨‰ªé WireGuard ÈÖçÁΩÆÊñá‰ª∂ÔºàÈªòËÆ§‰∏∫ÁõÆÂΩï‰∏≠ÊúÄÊñ∞ÁöÑ `.conf` Êñá‰ª∂ÊàñÁî®Êà∑ÊåáÂÆöÁöÑÊñá‰ª∂ÔºâËØªÂèñËÆæÁΩÆ„ÄÇ
2.  **IPset ÂàõÂª∫ÂíåÊõ¥Êñ∞Ôºö**
    *   ËÑöÊú¨‰ªé `config/domains.lst` Êñá‰ª∂ËØªÂèñÂüüÂêçÂàóË°®„ÄÇ
    *   ÂØπ‰∫éÊØè‰∏™ÂüüÂêçÔºåÊâßË°åÂºÇÊ≠• DNS Êü•ËØ¢ (`nslookup`) ‰ª•Ëé∑Âèñ IP Âú∞ÂùÄ„ÄÇ
    *   Ëé∑ÂæóÁöÑ IP Âú∞ÂùÄÂ∞ÜÊ∑ªÂä†Âà∞Â∏¶ÊúâË∂ÖÊó∂ÂíåÊ≥®ÈáäÔºàÂüüÂêçÔºâÁöÑ `unblock-list` IPset Ë°®‰∏≠„ÄÇ
    *   Ëøò‰ºöÂ§ÑÁêÜ `config/CIDR.lst` Êñá‰ª∂ÔºåÂπ∂Â∞Ü CIDR ËåÉÂõ¥Ê∑ªÂä†Âà∞ IPset„ÄÇ
3.  **Dnsmasq ÈÖçÁΩÆÔºö**
    *   ËÑöÊú¨Âú® `config/Dnsmasq/` ÁõÆÂΩï‰∏≠ÂàõÂª∫ÈÖçÁΩÆÊñá‰ª∂ `unblock.dnsmasq`„ÄÇ
    *   ÂØπ‰∫é `domains.lst` ‰∏≠ÁöÑÊØè‰∏™ÂüüÂêçÔºåÈÉΩÂ∞ÜÊ†ºÂºè‰∏∫ `ipset=/domain.com/unblock-list` ÁöÑË°åÊ∑ªÂä†Âà∞Ê≠§Êñá‰ª∂‰∏≠„ÄÇËøôÊåáÁ§∫ Dnsmasq Â∞ÜËøô‰∫õÂüüÂêçÁöÑ DNS Êü•ËØ¢Ë∑ØÁî±Âà∞ IPset„ÄÇ
4.  **WireGuard ÂêØÂä®Ôºö** ËÑöÊú¨‰ΩøÁî®ÈÖçÁΩÆÊñá‰ª∂‰∏≠ÁöÑÂèÇÊï∞ÈÖçÁΩÆÂπ∂ÂêØÂä® WireGuard Êé•Âè£ÔºàÈªòËÆ§‰∏∫ `wg0`Ôºâ„ÄÇ
5.  **Ë∑ØÁî±ÈÖçÁΩÆÔºö** ËÑöÊú¨ÈÖçÁΩÆË∑ØÁî±ËßÑÂàô (`iptables`„ÄÅ`ip rule`„ÄÅ`ip route`)Ôºå‰ª•ÈÄöËøá WireGuard Êé•Âè£Ë∑ØÁî±‰∏é `unblock-list` IPset ÂåπÈÖçÁöÑÊµÅÈáè„ÄÇ
6.  **ÂêéÂè∞ËøõÁ®ãÔºö** ÂêØÂä®ÂêéÂè∞ËøõÁ®ã‰ª•Ôºö
    *   Ê†πÊçÆ `syslog.log` ‰∏≠ÁöÑÊï∞ÊçÆÂÆöÊúüÊõ¥Êñ∞ IPset ‰∏≠ÁöÑÊ≥®Èáä„ÄÇ
    *   ÂÆöÊúü IPset Â§á‰ªΩÔºàÂèØÈÄâÔºâ„ÄÇ
    *   ÂÆöÊúüÊõ¥Êñ∞ `domains.lst` ‰∏≠ÂüüÂêçÁöÑ IP Âú∞ÂùÄ„ÄÇ

**ÈáçË¶ÅÊèêÁ§∫Ôºö** IPset ‰∏≠ÁöÑ IP Âú∞ÂùÄÂÖ∑ÊúâË∂ÖÊó∂ÔºàÈªòËÆ§‰∏∫ 12 Â∞èÊó∂Ôºâ„ÄÇËøôÊòØ‰∏∫‰∫ÜÊéíÈô§ÈÄöËøá VPN Ë∑ØÁî±ÂèØËÉΩÂ∑≤Êõ¥ÊîπÂÖ∂ IP Âú∞ÂùÄÁöÑÂüüÂêçÁöÑÊµÅÈáè„ÄÇ

### ‰ΩúËÄÖ <a name="authors-chinese"></a>

- **Spaghetti-jpg**: ÂéüÂßã‰ΩúËÄÖ„ÄÇ
- **Ivan Svarkovsky**: Ë¥°ÁåÆËÄÖ„ÄÇ

---

## Espa√±ol <a name="spanish-version"></a>

### Acerca de

Este script es un cliente VPN de WireGuard dise√±ado para enrutadores basados en firmware Padavan. Su funci√≥n principal es proporcionar **enrutamiento de tr√°fico selectivo** a trav√©s de una conexi√≥n VPN. Esto le permite configurar sitios web o direcciones IP espec√≠ficas para que se enruten a trav√©s de la VPN, mientras que el resto de su tr√°fico pasa directamente a trav√©s de su conexi√≥n a Internet normal.

**Prop√≥sito principal del script:**

*   **Evitar restricciones geogr√°ficas (bloqueo geogr√°fico):** El script est√° destinado principalmente a evitar las restricciones de acceso a contenido basadas en la ubicaci√≥n geogr√°fica del usuario.
*   **VPN selectiva:** En lugar de enrutar todo el tr√°fico a trav√©s de una VPN, puede enrutar selectivamente solo el tr√°fico de sitios espec√≠ficos, lo que puede ser beneficioso para la velocidad y la eficiencia de los recursos.
*   **Facilidad de instalaci√≥n y uso:** El script est√° dise√±ado teniendo en cuenta las limitaciones del firmware Padavan y no requiere la instalaci√≥n de paquetes adicionales (opkg), el uso de dig o un puerto USB.

### Caracter√≠sticas principales

*   **Gesti√≥n autom√°tica de IPset:** El script utiliza `ipset` para crear y gestionar un conjunto de direcciones IP que deben enrutarse a trav√©s de la VPN.
*   **Integraci√≥n de Dnsmasq:** El script genera un archivo de configuraci√≥n para `dnsmasq` de modo que las consultas DNS para dominios espec√≠ficos enruten autom√°ticamente el tr√°fico a trav√©s de IPset.
*   **Actualizaci√≥n din√°mica de IPset:** El script actualiza peri√≥dicamente las direcciones IP de los dominios de la lista `domains.lst` para mantener IPset actualizado, incluso si las direcciones IP del sitio web cambian.
*   **Soporte de CIDR:** Capacidad de agregar a IPset no solo direcciones IP individuales sino tambi√©n rangos CIDR completos desde el archivo `CIDR.lst`.
*   **Resoluci√≥n de dominio as√≠ncrona:** Uso de `nslookup` en modo as√≠ncrono para acelerar el procesamiento de grandes listas de dominios.
*   **Restauraci√≥n de comentarios de IPset desde Syslog:** Funci√≥n para agregar comentarios a las direcciones IP en IPset basados en datos del registro del sistema, mejorando la informaci√≥n en `ipset list`.
*   **Copia de seguridad y restauraci√≥n de IPset:** Funci√≥n para guardar y restaurar el conjunto IPset tras el reinicio del enrutador o fallos de alimentaci√≥n (opcional).
*   **Selecci√≥n de archivo de configuraci√≥n:** Capacidad de especificar la ruta al archivo de configuraci√≥n de WireGuard al ejecutar el script, o uso autom√°tico del archivo `.conf` creado m√°s recientemente.
*   **Modo Verbose:** Opci√≥n `-v` para habilitar la salida detallada del script.

### An√°lisis del script

El script funciona de la siguiente manera:

1.  **Lectura de configuraci√≥n:** Al inicio, el script lee la configuraci√≥n del archivo de configuraci√≥n de WireGuard (por defecto, el archivo `.conf` m√°s reciente en el directorio o especificado por el usuario).
2.  **Creaci√≥n y actualizaci√≥n de IPset:**
    *   El script lee la lista de dominios del archivo `config/domains.lst`.
    *   Para cada dominio, se realiza una consulta DNS as√≠ncrona (`nslookup`) para obtener direcciones IP.
    *   Las direcciones IP obtenidas se agregan a la tabla IPset `unblock-list` con un tiempo de espera y comentario (nombre de dominio).
    *   Tambi√©n se procesa el archivo `config/CIDR.lst` y los rangos CIDR se agregan a IPset.
3.  **Configuraci√≥n de Dnsmasq:**
    *   El script crea un archivo de configuraci√≥n `unblock.dnsmasq` en el directorio `config/Dnsmasq/`.
    *   Se agregan l√≠neas con el formato `ipset=/domain.com/unblock-list` a este archivo para cada dominio de `domains.lst`. Esto indica a Dnsmasq que enrute las consultas DNS para estos dominios a IPset.
4.  **Inicio de WireGuard:** El script configura e inicia la interfaz WireGuard (`wg0` por defecto) con par√°metros del archivo de configuraci√≥n.
5.  **Configuraci√≥n de enrutamiento:** El script configura reglas de enrutamiento (`iptables`, `ip rule`, `ip route`) para enrutar el tr√°fico que coincide con el IPset `unblock-list` a trav√©s de la interfaz WireGuard.
6.  **Procesos en segundo plano:** Se inician procesos en segundo plano para:
    *   Actualizaci√≥n peri√≥dica de comentarios en IPset basados en datos de `syslog.log`.
    *   Copia de seguridad peri√≥dica de IPset (opcional).
    *   Actualizaci√≥n peri√≥dica de direcciones IP de dominios de `domains.lst`.

**Importante:** Las direcciones IP en IPset tienen un tiempo de espera (12 horas por defecto). Esto es necesario para excluir el enrutamiento de tr√°fico a trav√©s de la VPN para dominios que puedan haber cambiado sus direcciones IP.

### Autores <a name="authors-spanish"></a>

- **Spaghetti-jpg**: Autor original.
- **Ivan Svarkovsky**: Colaborador.
